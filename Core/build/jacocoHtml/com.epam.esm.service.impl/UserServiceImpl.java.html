<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Core</a> &gt; <a href="index.source.html" class="el_package">com.epam.esm.service.impl</a> &gt; <span class="el_source">UserServiceImpl.java</span></div><h1>UserServiceImpl.java</h1><pre class="source lang-java linenums">package com.epam.esm.service.impl;

import com.epam.esm.dao.UserDao;
import com.epam.esm.exception.ServiceException;
import com.epam.esm.exception.ValidatorException;
import com.epam.esm.model.ERole;
import com.epam.esm.model.Role;
import com.epam.esm.model.UserStatus;
import com.epam.esm.service.RoleService;
import com.epam.esm.service.UserStatusService;
import com.epam.esm.util.LocalUtil;
import com.epam.esm.model.Dto.UserDto;
import com.epam.esm.model.User;
import com.epam.esm.service.UserService;
import com.epam.esm.validator.ValidatorEntity;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

/**
 * The type User service implements methods of the User interface.
 * The class is annotated as a service, which qualifies it to be automatically created by component-scanning.
 *
 * @author Alexander Pishchala
 */
@Service
public class UserServiceImpl implements UserService {

<span class="fc" id="L36">    private static final Logger logger = LoggerFactory.getLogger(UserServiceImpl.class);</span>

    private static final String USER_EXIST_CODE = &quot;code.user.exist_error&quot;;
    private static final String USER_BY_ID_NOT_FOUND_CODE = &quot;code.user.not_found&quot;;
    private static final String USER_BY_ID_NOT_FOUND = &quot;User not found by ID. ID: &quot;;
    private static final String USER_BY_EMAIL_EXIST_CODE = &quot;code.user.email.exist&quot;;
    private static final String USER_INVALID_DATA = &quot;code.user.invalid.data&quot;;
    private static final String REGEX_DELIMITER = &quot;/&quot;;

    private final static String ISO_FORMAT_DATE = &quot;yyyy-MM-dd'T'HH:mm:ss&quot;;

    private UserDao userDao;
    private LocalUtil localUtil;
    private PasswordEncoder passwordEncoder;
    private RoleService roleService;
    private UserStatusService userStatusService;

    @Autowired
    public UserServiceImpl(UserDao userDao,
                           LocalUtil localUtil,
                           PasswordEncoder passwordEncoder,
                           RoleService roleService,
<span class="fc" id="L58">                           UserStatusService userStatusService) {</span>
<span class="fc" id="L59">        this.userDao = userDao;</span>
<span class="fc" id="L60">        this.localUtil = localUtil;</span>
<span class="fc" id="L61">        this.passwordEncoder = passwordEncoder;</span>
<span class="fc" id="L62">        this.roleService = roleService;</span>
<span class="fc" id="L63">        this.userStatusService = userStatusService;</span>
<span class="fc" id="L64">    }</span>

    @Override
    public boolean save(UserDto userDto) {
<span class="nc" id="L68">        ValidatorEntity.user(userDto, localUtil);</span>
<span class="nc" id="L69">        Optional&lt;User&gt; existUser = userDao.findUserByEmail(userDto.getEmail());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (existUser.isPresent()) {</span>
<span class="nc" id="L71">            throw new ValidatorException(localUtil.getMessage(USER_EXIST_CODE));</span>
        }
<span class="nc" id="L73">        User user = new User();</span>
<span class="nc" id="L74">        user.setFirstName(userDto.getFirstName());</span>
<span class="nc" id="L75">        user.setLastName(userDto.getLastName());</span>
<span class="nc" id="L76">        user.setEmail(userDto.getEmail());</span>
<span class="nc" id="L77">        user.setCreateDate(getLocalDateTime());</span>
<span class="nc" id="L78">        user.setUpdateDate(getLocalDateTime());</span>

<span class="nc" id="L80">        Set&lt;Role&gt; roles = new HashSet&lt;&gt;();</span>
<span class="nc" id="L81">        roles.add(roleService.findRole(ERole.USER.name()));</span>
<span class="nc" id="L82">        user.setRoles(roles);</span>
<span class="nc" id="L83">        user.setPassword(passwordEncoder.encode(userDto.getPassword()));</span>
<span class="nc" id="L84">        return userDao.create(user);</span>
    }

    @Transactional
    @Override
    public Optional&lt;UserDto&gt; showUser(int id) {
<span class="nc" id="L90">        Optional&lt;User&gt; user = userDao.findUser(id);</span>
<span class="nc" id="L91">        return user.map(value -&gt; builderUserDto(Collections.singletonList(value)).get(0));</span>
    }

    @Transactional
    @Override
    public Optional&lt;UserDto&gt; showUserByEmail(String email) {
<span class="nc" id="L97">        Optional&lt;User&gt; user = userDao.findUserByEmail(email);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (user.isPresent()) {</span>
<span class="nc" id="L99">            UserDto newUser = user.map(value -&gt; builderUserDto(Collections.singletonList(value)).get(0)).get();</span>
<span class="nc" id="L100">            newUser.setPassword(user.get().getPassword());</span>
<span class="nc" id="L101">            return Optional.of(newUser);</span>
        }
<span class="nc" id="L103">        return Optional.empty();</span>
    }

    @Transactional
    @Override
    public List&lt;UserDto&gt; showUserList(int limit, int offset) {
<span class="nc" id="L109">        List&lt;User&gt; userList = userDao.findUserList(limit, offset);</span>
<span class="nc" id="L110">        return builderUserDto(userList);</span>
    }

    @Transactional
    @Override
    public List&lt;UserDto&gt; showUsersByName(String name, int limit, int offset) {
<span class="nc" id="L116">        List&lt;User&gt; userList = userDao.findUsersByName(name, limit, offset);</span>
<span class="nc" id="L117">        return builderUserDto(userList);</span>
    }

    @Override
    public int showCountUsers() {
<span class="nc" id="L122">        return userDao.findCountUsers();</span>
    }

    @Override
    public boolean changeUserRole(UserDto userDto) {
<span class="nc" id="L127">        Optional&lt;User&gt; user = userDao.findUser(userDto.getUserId());</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (user.isEmpty()) {</span>
<span class="nc" id="L129">            logger.error(USER_BY_ID_NOT_FOUND + userDto.getUserId());</span>
<span class="nc" id="L130">            throw new ServiceException((localUtil.getMessage(USER_BY_ID_NOT_FOUND_CODE)) + userDto.getUserId());</span>
        }
<span class="nc" id="L132">        Role roleDB = roleService.findRole(userDto.getRoles().stream().findFirst().orElseThrow(() -&gt; new ServiceException((localUtil.getMessage(USER_BY_ID_NOT_FOUND_CODE)) + userDto.getUserId())));</span>
<span class="nc" id="L133">        Set&lt;Role&gt; roleSet = new HashSet&lt;&gt;();</span>
<span class="nc" id="L134">        roleSet.add(roleDB);</span>

<span class="nc" id="L136">        user.get().setRoles(roleSet);</span>
<span class="nc" id="L137">        user.get().setUpdateDate(getLocalDateTime());</span>
<span class="nc" id="L138">        return userDao.update(user.get());</span>
    }

    @Override
    public boolean changeUserStatus(UserDto userDto) {
<span class="nc" id="L143">        Optional&lt;User&gt; user = userDao.findUser(userDto.getUserId());</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (user.isEmpty()) {</span>
<span class="nc" id="L145">            logger.error(USER_BY_ID_NOT_FOUND + userDto.getUserId());</span>
<span class="nc" id="L146">            throw new ServiceException((localUtil.getMessage(USER_BY_ID_NOT_FOUND_CODE)) + userDto.getUserId());</span>
        }
<span class="nc" id="L148">        UserStatus status = userStatusService.findStatus(userDto.getStatus());</span>
<span class="nc" id="L149">        user.get().setStatus(status);</span>
<span class="nc" id="L150">        user.get().setUpdateDate(getLocalDateTime());</span>
<span class="nc" id="L151">        return userDao.update(user.get());</span>
    }

    @Override
    public boolean update(UserDto userDto) {
<span class="nc" id="L156">        User user = userDao.findUser(userDto.getUserId()).orElseThrow(() -&gt; new ServiceException((localUtil.getMessage(USER_BY_ID_NOT_FOUND_CODE)) + userDto.getUserId()));</span>
<span class="nc" id="L157">        ValidatorEntity.userForUpdate(userDto, localUtil);</span>
<span class="nc" id="L158">        List&lt;String&gt; listPasswords = Arrays.asList(userDto.getPassword().split(REGEX_DELIMITER));</span>

<span class="nc bnc" id="L160" title="All 4 branches missed.">        if(!listPasswords.isEmpty() &amp;&amp; passwordEncoder.matches(listPasswords.get(0), user.getPassword())) {</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            user.setFirstName(userDto.getFirstName() != &quot;&quot; ? userDto.getFirstName() : user.getFirstName());</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            user.setLastName(userDto.getLastName() != &quot;&quot; ? userDto.getLastName() : user.getLastName());</span>
<span class="nc" id="L163">            user.setUpdateDate(getLocalDateTime());</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">            if(userDao.findUserByEmail(userDto.getEmail()).isEmpty()) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                user.setEmail(userDto.getEmail() != &quot;&quot; ? userDto.getEmail() : user.getEmail());</span>
            } else {
<span class="nc" id="L168">                throw new ServiceException((localUtil.getMessage(USER_BY_EMAIL_EXIST_CODE)));</span>
            }

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if(listPasswords.size() == 2) {</span>
<span class="nc" id="L172">                user.setPassword(passwordEncoder.encode(listPasswords.get(1).trim()));</span>
            }
        } else {
<span class="nc" id="L175">            throw new ServiceException((localUtil.getMessage(USER_INVALID_DATA)));</span>
        }
<span class="nc" id="L177">        return true;</span>
    }

    @Override
    public boolean remove(int id) {
<span class="nc" id="L182">        User user = userDao.findUser(id).orElseThrow(() -&gt; new ServiceException((localUtil.getMessage(USER_BY_ID_NOT_FOUND_CODE)) + id));</span>
<span class="nc" id="L183">        return userDao.delete(user);</span>
    }

    private LocalDateTime getLocalDateTime() {
<span class="nc" id="L187">        return LocalDateTime.parse(</span>
<span class="nc" id="L188">                LocalDateTime.now().format(DateTimeFormatter.ofPattern(ISO_FORMAT_DATE)));</span>
    }

    /**
     * Builder list of User Dto by list of User entity. This is a helper method needed to avoid
     * code duplication.
     *
     * @param userList the list of users.
     *
     * @return list of User Dto.
     */
    @Transactional
    private List&lt;UserDto&gt; builderUserDto(List&lt;User&gt; userList) {
<span class="nc" id="L201">        List&lt;UserDto&gt; userDtoList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        for(User user : userList) {</span>
<span class="nc" id="L203">            UserDto userDto = new UserDto();</span>
<span class="nc" id="L204">            userDto.setUserId(user.getUserId());</span>
<span class="nc" id="L205">            userDto.setFirstName(user.getFirstName());</span>
<span class="nc" id="L206">            userDto.setLastName(user.getLastName());</span>
<span class="nc" id="L207">            userDto.setEmail(user.getEmail());</span>
<span class="nc" id="L208">            userDto.setRoles(mapRoles(user.getRoles()));</span>
<span class="nc" id="L209">            userDto.setStatus(user.getStatus().getName().name());</span>
<span class="nc" id="L210">            userDtoList.add(userDto);</span>
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">        return userDtoList;</span>
    }

    /**
     * The method maps a collection of roles from a Set list
     * @param roles the set list of roles.
     * @return Collection roles.
     */
    private Collection&lt;String&gt; mapRoles(Set&lt;Role&gt; roles) {
<span class="nc" id="L221">        Collection&lt;String&gt; role = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L222">        roles.forEach(eRole -&gt; role.add(eRole.getName().name()));</span>
<span class="nc" id="L223">        return role;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>